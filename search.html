---
layout: with_sidebar
body: search
title: Archives
dependencies: *
---
{% if site.tapir_token %}
<div class="shadow-box" id="search_results_area">
	<h2>Posts <span id="result_count"></span></h2>
	<ol id="search_results" class="dates">
	</ol>
</div>

<script type="text/javascript">
	window.addEventListener("load", function() {
		var tapir = function(query, callback) {
			if (window.XMLHttpRequest) {
				req = new XMLHttpRequest()
			} else {
				req = new ActiveXObject("Msxml2.XMLHTTP")
			}
			if (!req) return;

			req.onreadystatechange = function () {
				if (req.readystate != 4) return;
				if (req.status != 200) {
					// FIXME: error message
					callback([])
				} else {
					callback(JSON.parse(req.responseText))
				}
			}
			req.open('GET', 'http://tapirgo.com/api/1/search.json?token={{ site.tapir_token }}&query=' + encodeURIComponent(query));
			req.send();
		}

		var search_results = document.getElementById('search_results')
		var search_field = document.getElementById('search');
		var query = window.location.search.match(/query=(.+?)(\x26|$)/)
		if (query) search_field.value = query[1]

		search_field.form.onSubmit = function() {	
			var query = search_field.value;
			if (!query) return;

			search_results.className = 'searching';
			tapir(query, function(results) {
				search_results.className = '';
				var resultCount = document.getElementById('result_count')
				if (resultCount.textContent) resultCount.textContent = '(' + results.length + ')';
				else resultCount.innerText = '(' + results.length + ')';

				search_results.innerHTML = results.map(function(post) { return '\
					<li>\
						<span class="date">' + post.published_on.substr(0,10) + '</span>\
						<a href="' + post.link + '">' + post.title + '</a>\
					</li>';
				}).join('');
			});

			return false;
		};
		search_field.form.onSubmit();
	});
	
</script>
{% else %}
<div class="shadow-box" id="search_results_area">
	<p>Search is not enabled on this site.
</div>
{% endif %}
